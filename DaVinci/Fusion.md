# Fusion官方教程笔记

Date: 2025-03-11

---

## 1 Fusion页面

基本布局:

- 上部: 左右Viewer, 检查器
- 中间: 常用效果或工具按钮
- 下部: 节点编辑区/关键帧/样条曲线编辑器

在Fusion中浏览:

- 平移视图: 鼠标中键拖拽
- 缩放视图: Cmd+滚轮
- 缩放到100%, 200%: Cmd+1, Cmd+2 
- 视图自适应大小: Cmd+F 

一般情况下mediaIn对应左Viewer, MediaOut对应右Viewer, 理论上任何节点都可在任意Viewer中显示
实现方式: 选中--1或2 

右击节点区空白区域, 其中选项可选到适合自己工作的习惯

F2节点重命名为有意义的名字, 推荐驼峰样式, 为理清逻辑关系打好基础.

合成: 指将两个或多个图像组合在一起来创建一个最终的效果镜头. 英文: Merge

**节点间的连线, 重要的不是连接的位置, 而是连接端口的颜色!**

常见端口:

- 绿色: 前景输入
- 黄色: 背景输入
- 蓝色: 遮罩输入
- 白色矩形: 输出端口

Cmd+T: 前景/背景输入互换快捷键

常规操作:

- 断开连线: 双击
- 重连: 拖拽
- 移除/添加节点到连线中间: Shift+拖拽节点
- 自动添加节点: 新节点始终直接添加到所选中节点的后面
- 打开选择工具对话框: Shift+Space

虽然不理解但要记住: **CG元素几乎总是预乘的, 所以在处理预乘图像时, 需要在色彩校正器中开启"Pre-Divide/Post-Multiply(预除/后乘)"选项**

DeepSeek解释:

> 三者关系与工作流程
> 预乘：原始图像存储为预乘格式（RGB已乘Alpha）。
> 预除：处理前将RGB除以Alpha，还原原始颜色。
> 颜色校正：在原始颜色空间进行调整，避免Alpha干扰。
> 后乘：校正后的RGB重新乘以Alpha，恢复预乘状态。
> 为什么CG元素需要预乘？
> 渲染效率：预乘是渲染引擎的标准输出格式，减少合成时的计算量。
> 抗锯齿需求：预乘能正确处理半透明边缘，避免锯齿或颜色污染。
> 行业规范：主流合成软件（如Nuke、After Effects）默认支持预乘图像。
> 总结
> 预乘是存储透明图像的高效方式。
> 预除/后乘是颜色校正的必要步骤，确保处理基于真实颜色，同时维持预乘格式的兼容性。
> 在DaVinci中开启“Pre-Divide/Post-Multiply”选项，本质是在处理链中嵌入还原与恢复预乘的操作，保障颜色校正的准确性。

在例子中勾选预除/后乘是为了单独调节DriveDock元素的颜色属性

色彩校正器选项:

- 提升(Lift): 调整图像中暗部像素的幅度
- 增益(Gain): 调整亮部信息的幅度
- 伽马(Gamma): 调整暗部区域和亮部区域的像素对比度

Cmd+P: 节点开关切换

### 遮罩

例子中, 需要硬盘驱动器CG遮住实拍背景中的背部模拟, 同时需要背景中的手持硬盘遮住CG:

1. CG作为前景合并到实拍背景中遮挡实拍背景中人物背部, 调整颜色使之匹配和谐
2. 制作实拍背景中的手持硬盘动态遮罩(素材提供)
3. 遮罩连接到CG中, 此时CG还是在前景
4. CG应用反转遮罩, 搞定
   简单来说就是把背景中的一部分利用动态遮罩, 越过原前景来到最前端作为新前景
   逻辑最清晰但操作很麻烦的方法是: 剪辑页面搞三层, 最上面背景视频动态遮罩的手持硬盘, 中间CG画面, 最下面背景视频

### 二次颜色校正

亮度键控器(Luma Keyer): 根据图像中的明度来分离像素, 实际上还可通过色相/饱和度/Alpha等进行分离
使用亮度键控器的关键在于选好通道类型, 调整低点和高点, 清晰地分离出目标像素
利用亮度键控器可分离出高光的青色灯光部分, 通过色彩校正器改成红色或其他颜色灯光

例子中改用色相通道貌似效果更好一些
有时Merge节点多一个逻辑关系更明晰

### 关键帧动画

目标: 青色灯光从50帧开始向红色转化到70帧结束完全变为红色
步骤:

1. 移动到70帧, 选择色彩校正器2, 打开设置
2. 点击混合(Blend)后右侧的关键帧
3. 移动到55帧, 混合拖拽到0.0, 关键帧自动打上

Blend混合可以理解为交叉溶解: 混合值为0.0将输出没有受影响的源片段; 值为1.0将以最大强度输出"受影响"的版本; 中间值为部分受影响.

### 小结

关键点:

1. CG添加后的调色, 目的是和环境相符
2. 手部前后景难题
   - CG前景和实拍背景关系不变, 作为背景一部分的手持硬盘要求在前景之上显示
   - 手部动态遮罩, 素材提供
   - CG设置中, 应用反转遮罩
3. 变色关键帧动画
   - 亮度键控器可根据亮度/色相等分离特定像素
   - 调出红色
   - 通过亮度键控器混合关键帧在特定帧数间实现动画

*Tips*:

- 一个输出可对应N个输入
- Note是个好工具, 记录关键点位和容易混淆的逻辑关系

## 2 分屏合成

组合多个不同的图像来形成一个可以相信的新整体.
视觉特效合成的目的就是"让观众相信", 无论拍摄主体有多么梦幻, 都是由一台实拍摄像机现场录制拍摄的结果.

合成时其中最关键的一个方面是让所有不同的元素跟随同一个摄像机的运动轨迹。这些通常被称之为匹配移动, 你需要分析背景片段的运动并将它应用到某个前景片段上, 反之亦然.
说人话: 新加入的内容在位移和形变上要符合原摄像机和原画面的逻辑关系

D: 片段使用与否切换开关, 一般用于剪辑页面中的视频堆叠

本章目标: 一个镜头中有AB两个演员, 在片段1中A表现好, 片段2中B表现好, 将两个片段中表现好的部分组合成一个新的画面.

跟踪的三种主要技术:

- 点跟踪
- 平面跟踪
- 三维摄像机跟踪

将两个叠加片段都导入到Fusion页面, 必须在Edit页面创建一个Fusion片段

### 跟踪

创建分屏效果最简单的方法是从两个片段中去除所有摄像机的运动, 实现方法就是应用点跟踪器(Tracker)

Cmd+左箭头: Fusion页面中将播放头移动到渲染范围起始处.

点跟踪器: 

- 注意: 软件默认使用IntelliTrack(智能跟踪器), 注意选择point(点跟踪器)
  - 在检查器中, 先增加三个点跟踪器再删除智能跟踪器!!!
- 适合跟踪**运动的/高对比度**的图案
- 有两个矩形框, 内框是识别它跟随高对比度的图案, 外框是表示搜索区域; 可通过左上角控制手柄, 拖拽它来放置内框的位置
- 优先跟踪点位置: 高对比度, 清晰, 始终在镜头中
- 在稳定镜头时, 单个跟踪点只稳定画面内这个图案的平移运动
  - 画面若有缩放和旋转, 至少需要三个跟踪点来防止图像移动/缩放和旋转.
  - 绝大多数下, 都应该有三个点跟踪, 几何中的三点决定一个平面; 画面可理解为一个二维的平面.
- 点击从第一帧开始跟踪
- 跟踪的目的在于使用跟踪数据来稳定这个片段
  - 跟踪器的检查器中点击"操作"选项卡
  - "操作"中选择匹配移动
  - 在"合并"中选择"只有背景"
- 播放片段查看效果
  - 稳定的工作原理是从跟踪器获取 摄像机运动, 在反向这个运动路径, 并将它应用会同一片段.
- 同样方式稳定"司机"片段

### 绘制蒙版

有相当一部分的合成与绘制蒙版有关, 有时也称之为动态遮罩. 蒙版有助于分离图像的特定区域, 以便在需要时只把效果应用在这个区域中.
蒙版和遮罩这两种术语经常交替使用. 在本书中, 蒙版指的是灰度图像, 用来识别透明和不透明的像素. 而遮罩是指蒙版的应用. 即, 你使用蒙版来遮住图像的某一部分的行为称为遮罩.

最好在渲染的起始位置或结束位置时添加多边形遮罩形状, 因为**遮罩形状会自动设置动画!!!**

在多边形蒙版绘制时的最后一步推荐使用快捷键: Shift+O来闭合形状, 有时鼠标点击会出现失误.

工作原理:

- 片段2的演员B表现良好, 位于时间线叠加上面; 片段1的演员A表现良好, 位于时间线叠加的下面
  - 此时只显示片段2的全部画面, 包括其中A的糟糕表现, 同时, 片段1中A的良好表现被遮挡看不见
  - 目标: 同时显示片段2中的B和片段1中的A 
- 在片段2上面绘制多边形蒙版, 隔离出表现良好的B(同时用于遮住片段1中表现不好的B)
- 对于Merge节点来说:
  - 多边形蒙版白色部分放行, 黑色部分阻止继续显示作为背景的片段1 
  - 说人话: 蒙版裁切了需要的部分贴到了背景上, 重要的是还可对覆盖部分进行关键帧动画动态调整, 完美!

使用微调来对齐片段:
因为无法保证每次拍摄都在完全相同的位置开始, 因此两个镜头总会略有偏差, 上述操作在结合处总会有某种"撕裂".
下面的操作尽可能减少两个镜头之间的差异(注意是尽可能, 不可能完全消除差异)

- 暂时断开多边形节点
- Merge的应用模式改为差异
  - 在此模式中, 只要重叠的前景和背景像素相同时, 就会显示黑色; 不同的部分会以高亮显示
- 调整"中心X轴"和"中心Y轴", 直到**大部分**汽车背景变成黑色
- 对齐完成后, 将Merge应用模式返回Normol正常, 重新将多边形节点连接
  此时可改善接缝处的撕裂感, 同时增大蒙版上的模糊来柔化过度

### 恢复摄相机运动

- 在Merge节点前添加变换节点, 选择数字2, 在右Viewer中显示
  - 使用跟踪器节点来跟踪图像之后, 就可以从跟踪器发布它的跟踪数据, 这样其他节点就能直接调用, 不用反复跟踪
- 右击变换的中心控制点
  - 选择: 变换1: 中心--连接到--跟踪器2--取消稳定位置
- 由于稳定效果会让一部分画面边缘出现空缺, 所以最后一步是适当放大画面, 来填补空缺

最终节点树:
![image](/Users/maverick/Documents/Note/media/splitCreen.png)

### 小结:

- 不理解为什么要先消除摄像机运动, 然后再恢复运动. 为了绘制蒙版???
- 最核心的部分就是多边形蒙版的工作原理以及操作注意事项
- 目前能想到的应用场景: 一人分饰两角
  - 固定相机拍摄两段同背景素材
  - 多边形蒙版分割融合两段视频到一个画面

## 3 替换天空

露天拍摄, 天气不可控, 为了整体效果, 可通过后期改变天气状况.
前提: 前景视频1080P, 背景图片3888x2187

### 3.1 分辨率问题

不论原始素材分辨率多少, 创建Fusion片段之后, 分辨率都会和时间线分辨率相同. 如果源片段和时间线有相同的分辨率, 那么设置Fusion合成是最有效的办法.
但如果处理的片段分辨率大于时间线分辨率, 那么最合适的操作就是采用混合分辨率的方式来处理片段.

与Fusion片段不同, 将单个片段从剪辑页面导入到Fusion页面可以保持片段的原始分辨率, 而不用考虑时间线的设置.

- 剪辑页面D禁用1080P素材, 直接转到Fusion页面
- 在静态图片前面加上一个背景
  - 在合成时必须有一个背景, 否则不能输出影像, 如果没有就加一个抽象的也行; 这个背景决定了输出的分辨率
  - 检查器--image图像--取消自动分辨率复选框--输入分辨率
  - 这相当于在4K分辨率的图片上加了一个HD的窗口, 可以调整哪个部分可显示出来, 也就是灵活度高的裁剪 
- 媒体池中拖入1080P素材作为前景, 连接到图片输出端口

### 3.2 使用变暗应用模式合成

合成通常会需要Alpha通道或蒙版, 蒙版或Alpha通道用来告诉软件需要切除前景的哪些区域从而显示背景.
但Merge当中还有一个应用模式用来替换天空是个好工具.

- 选择Merge1, 在检查器中将应用模式设置为"变暗"
  - 含义为: 无论前景和背景在何处重叠,"变暗"应用模式都会显示较暗的像素
  - 前景天空图像过曝, 背景图片更暗, 因此大部分背景图片会显示出来
- 在天空节点处添加变换节点, 仍然可使用原始分辨率, 只不过要通过1080P的限制来决定显示哪里以及多少
  - 多在左Viewer中反复观看SKY, 变换节点, Merge2就能明白在说什么
  - 拖动变换节点中心点, 选取最漂亮的部分显示在最终画面里

### 3.3 蒙版复合制作

特效库分门别类地列出了所有的效果节点, Shift+Space快捷调出"工具选择"是通过关键词搜索需要的效果, 他们两者指向的目标相同, 获得方式有区别而已.

亮度键控器LumaKeyer的功能就是为没有Alpha通道的RGB图像添加Alpha通道.

- Shift+Space或特效库中添加亮度键控器, 放到Actors节点旁
- Actors节点拖出第二条输出到亮度键控器的黄色输入上, 再强调一遍: *一个节点可以有若干输出*
- 因为亮度键控器带来了Alpha通道, 会看到半透明棋盘格, 在LeftViewer的颜色控制中选择Alpha通道
  - 所谓Alpha通道, 是附属在图形的RGB通道中的第四个通道, 用来决定透明度的. "黑透白不透, 灰色半透明"
  - 快捷键: A/C, 切换Alpha和彩色通道
- 检查器中通道选择亮度, 调整阈值高低滑块, 直到大部分天空显示为纯白色, 前景演员和环境尽可能变成黑色
  - 蒙版的一个重要特征就是仅包含纯黑和纯白
  - 为平滑粗糙的边缘, 适度调整Blur模糊滑块
  - 此时前景还有部分白色, 下面进行优化修复
- 激活亮度键控器, 添加侵蚀/扩张(Erode/Dilate)节点, 在LeftViewer中显示
  - 调整数量滑块, 使得前景全黑, 同时的副作用就是也扩张了岩石的边缘
  - 再接一个侵蚀扩张节点, 反向调节, 得到一个近乎完美的蒙版
  - 侵蚀扩张节点可串联使用真是太棒了!
  - 下面修复前景上的一些瑕疵白点
- 使用亮度键控器创建的蒙版必须与演员的RGB图像相结合, 创建蒙版控制MattControl节点, 主要功能为获取Alpha通道并将它复制到已连接背景输入端口的图像中.
  - 从Actors节点拖出第三个输出连接到蒙版控制的黄色输入端口上, 在LeftViewer中显示. 以颜色模式显示C
  - 将第二个侵蚀扩张的输出连接到蒙版控制的前景输入端口
  - 在检查器中将组合设置为: 组合Alpha通道, 并在底部启用"后乘图像"
  - 通过选择“组合Alpha通道”，我们告诉Fusion将Alpha通道从“LumaKeyer（亮度键控器）”在前景输入上输入节点）复制到“ACTORS（演员）”图像的Alpha通道（在背景输入上输入）。
  - 点选反转蒙版复选框
- 激活Merge1再添加一个Merge3, 蒙版控制输出连接到Merge3的绿色前景输入端口上

至此, 除了天空显得有点假外其他差不多了

总结一下:

1. 利用Merge的"变暗"应用模式把背景中曝光正常的天空显示到前景过曝的天空中, 这个需要优化

2. 使用LumaKeyer为ACTORS节点添加Alpha通道, 在LeftViewer中以Alpha通道模式显示, 检查器中调整阈值高低点, 尽量优化, 适度模糊

3. Erode/Dilate优化前景, 但会侵蚀背景; 串联反向修复侵蚀部分

4. 蒙版必须与ACTORS的RGB图像结合, 这是MatteControl的重要作用, 如何连接有两种方式
   
   - ACTORS输出到MatteControl背景输入
   
   - 第二个Erode/Dilate连入垃圾蒙版入口, 不需要反转蒙版(另一种方式参看前面部分)
   
   - 组合: 组合Alpha通道, 底部启用"后乘图像"

### 优化天空

天空是静态图片, 要让它随着摄像机运动起来. 很自然地想到跟踪器.

需要将"Tracker跟踪器"修改器应用到包含位置控制的节点上, Merge工具包含中心X轴和Y轴控制, 可以用来重新定位已连接到前景输入端口的片段.

- 激活Merge2在LeftViewer中显示, 右击: Merge2中心--修改为--跟踪器位置
  - 这样跟踪器被附加到Merge2节点的X/Y轴控制上
  - 检查器中点击修改器--跟踪器来源
  - **节点编辑器中将Actors节点拖拽到上面位置**
- 播放头移动到渲染范围起始处, LeftViewer中, 拖动图案左上角控制手柄, 将跟踪器放置在高对比度处
- 点击向前跟踪 
- 若有中断, 播放头置于中断处
  - 再定位一个高对比度位置, 检查器中将路径中心设置为跟踪中心(追加)
  - 再次向前追踪
- 如果边缘出现黑色, 那是跟踪到了天空图片以外的范围, 返回头调整变换1节点即可
- 激活天空节点, 添加颜色校正器, 调整颜色到不违和.

最终节点树参考:
![image1](/Users/maverick/Documents/Note/media/2025-03-13.png)

### 小结:

- 如果有高分辨率素材尽量选用, 提高灵活度, 实现方式:
  - 直接转到Fusion页面, 如果有前景叠加, 在Edit页面快捷键"D"--禁用 
  - 前面添加背景节点:
    - 检查器--image图像
    - 取消自动分辨率复选框
    - 输入时间线设置分辨率
    - 高分辨率素材从前景输入Merge节点
- Merge节点的应用模式中有"变暗", 它的工作原理是: 前后景重叠, 只显示比较暗的像素.
  - 同理: "变亮"显示比较亮的像素, 要根据实际情况灵活掌握
- 亮度键控器的主要作用是为RGB图像添加Alpha通道, 依据为亮度(可调整为色相/饱和度等依据)
- Alpha通道显示/控制透明度, "白透黑不透, 灰色半透明"
  - Viewer显示模式可选(快捷键):
    - 正常颜色: C
    - Alpha: A
- 蒙版的一个重要特征就是仅包含纯黑和纯白, 说人话: 若有灰色, 证明调整不到位--除非有意为之
- 侵蚀/扩张: 调整前景的同时, 也会影响背景的区域范围, 最牛逼的地方在于可串联进行反向调节, 同时保护了前一步的调整.
- 蒙版控制MattControl节点的主要作用: 将Alpha通道信息复制到背景(Actors节点)输入上
  - 关键点: 检查器中组合设置为: "组合Alpha通道", 启用"后乘图像", 点选反转蒙版复选框
  - 通过选择“组合Alpha通道”，我们告诉Fusion将Alpha通道从“LumaKeyer（亮度键控器）”在前景输入上输入节点）复制到“ACTORS（演员）”图像的Alpha通道（在背景输入上输入）。
- 运动镜头对静态图片有天然的违和感, 需要图片也要随着镜头动起来. 这是跟踪和保持图片高分辨率的原因所在
- Merge具有位置控制功能--修改器中跟踪器来源可从节点树中直接拖拽

本章练习题目总结: 这道练习题出现的位置不正确, 利用单点跟踪无法实现, 只有利用下章的PlanarTracker平面跟踪节点才有可能实现题目要求!!!

知识点: <mark>多边形工具取消手柄联动: 鼠标先点击手柄再按住Cmd!</mark>

1. PlanarTracker **圈出目标**跟踪, 获得跟踪数据

2. 建立新分支, 深刻理解分支相当于时间线中的复制
   
   - TimeStretcher创建冻结帧(非必要步骤, 仅在追踪位置必须出现在片段中间才有必要)
   - 多边形Polygon圈出目标
   - MatteControl负责结合遮罩与图像
     - 遮罩来自Polygon1, 图像来自MediaIn2

3. PlanarTracker仅限向四角定位器传输数据, 而PlanarTransform可向非规则图像传输数据, 所以在PlanarTracker检查器中生成PlanarTransform并自动复制跟踪数据

4. 连接MatteControl和PlanarTransform?
   
   - 难点在这里, 如何连接? <mark>跟踪数据要送给哪个节点, 就要连接在目标节点后面</mark>
   
   - 跟踪数据要送给Polygon1圈出的目标机器人, 所以要连入Polygon1后面, MatteControl1之前.

5. 分离/追踪完成, 添加要求的效果
   
   - MediaIn添加Blur, Blur Size: 10
   - PlanarTransform添加BrightnessContrast
   - Merge2后添加Blur2, Blur Size: 5

两个Blur和BrightnessContrast添加位置体现了分支意味着复制的深刻含义

![](/Users/maverick/Documents/Note/media/Robots.png)

## 4 平面替换(屏幕/路牌/标志等)

本章主要学习平面跟踪器PlanarTracker.

三部曲:

1. 需要在它们移动时对平面进行跟踪
2. 使用画笔Paint工具, 删除所有跟踪标记来创建一个干净的表面
3. 使用跟踪出来的数据把新标志合成到干净的表面上

### 4.1 跟踪平面

平面跟踪器使用的不是一个或两个跟踪点, 相反, 它会使用很多个跟踪点来解算出所跟踪平面的运动/缩放/透视变形.

为平面跟踪选择一个优秀的特征区域:

- 选择尽可能大的区域
- 选择尽可能保持在帧画面的区域
- 选择一个在前景中没有移动障碍物的区域
- 当要跟踪的区域达到最大尺寸的时候, 再开始跟踪. 开始跟踪时, 要争取该区域的细节足够多
- 确保选择中包含的所有内容都是统一不变形体的一部分. 即不能包含独立转动的车轮等
- 平面区域的镜头畸变最小的那一帧上开始跟踪

操作:

1. 添加平面跟踪器PlanarTracker, 按照上面的原则选择一个合适帧, 例子中选择第65帧
2. 绘制方法和多边形用法类似在汽车侧面绘制一个简单的形状, 该形状内的区域是随着时间要被跟踪的图案Pattern
3. 在检查器中点击"set", 当前帧被设置为轨道上剩余部分的参考帧
   - 若有中断, 必须在恢复跟踪之前重新点击"set"按钮
   - 点击Track to Start, 跟踪完成后点击"Go"回到第65帧处
   - 点击"Track to End"
   - 确保"操作模式Operation Mode"选择"Track(跟踪)"

至此得到跟踪数据

### 4.2 使用克隆工具绘制

需要使用冻结帧来清理标志或不需要的部分

操作:

1. 时间拉伸器TimeStretcher, 用来创建冻结帧. 将MediaIn输出再拉一条线连接到时间拉伸器的黄色输入端口
   - 从MediaIn节点拖拽第二条输出线类似于时间线中复制了一个片段
   - 从"源"连接到时间拉伸器时, 它会自动添加一个关键帧. 方便制作片段变速, 但冻结帧需要先关闭这个关键帧
   - 在"源时间SourceTime"输入框中, 输入65以在整个镜头中指定冻结帧
2. 擦除冻结帧上的所有标记
   - 选择时间拉伸器, 在工具栏中点击"画笔Paint", 添加节点
   - Viewer上方会显示出各种绘画控件, 选择"画笔Stroke"工具, 此为通用工具, 可完成大多数任务
   - 检查器中点击"应用控制ApplyControl"中的"克隆Clone"按钮, 画笔就切换到了克隆画笔的绘制; 原理和用法类似PS中的"仿制图章"
3. Fusion--导入提供的透明logo图片, 连接到画笔节点的输出上, 自动创建Merge节点
   - 选择Merge节点, 在检查器中把应用模式设置为"柔光SoftLight"
   - 在logo节点后插入"亮度对比度BrightnessContrast"节点, 调整至不违和
   - 勾选检查器中"预除/后乘", 以消除边缘的锯齿感

至此冻结帧基本完工, 后面需要提供给位置, 透视等等

关于直接和预乘Alpha通道的知识点:
为了在Alpha通道中显示经过抗锯齿处理的边缘, Fusion对边缘像素执行了乘法运算.
在Fusion中可先对预乘的Alpha通道进行除法操作, 然后进行颜色校正, 最后再对边缘进行乘法操作. 
大多数颜色校正工具都包含了一个"预除/后乘"的复选框, 可帮你完成任务.

### 4.3 四角定位CornerPositioner与结合蒙版和图像

1. 选择亮度对比度BrightnessContrast节点, 添加四角定位器CornerPositioner
   - Fusion的坐标系: 左下角为原点, 以百分比转换后的小数为单位, 如中心点为(0.5, 0.5), 右上角(1.0, 1.0)
   - 在检查器中定位好四个角的坐标, 特殊需求直接鼠标拖动
2. 添加多边形到Merge1附近, 绘制区域
   - 特效蒙版(EffectMask)是用来限制特效插件的作用区域的
   - 垃圾蒙版(GarbageMatte)用来把图像和蒙版结合, 而蒙版控制(MatteControl)正好有垃圾蒙版的入点(灰色)
3. 选择Merge1, 添加蒙版控制(典型使用场景式从前景或组合蒙版到背景上). 将多边形节点连入灰色垃圾蒙版, 多边形选择反转

### 4.4 使用平面变换(PlanarTransform)来匹配移动

对于简单的四角定位图像, 可直接连接到PlanarTracker上. 但当处理不规则的多边形蒙版形状或宽高比和分辨率有差异的合成时, 应该使用"平面变换PlanarTransfrom".

1. 选择"平面跟踪器PlanarTracker"节点, 检查器底部点击创建"平面变换Planar Transform", 它包含了平面跟踪器解算出来的所有变换数据和透视变形数据.
2. 将蒙版控制的输出连接到平面变换的黄色输入端口, 删除平面跟踪器(数据已经被复制)
3. 连接平面变换和MediaIn输出端口

至此, 主体工程完工, 余下的是完善
给新添加的logo添加运动模糊, 使其更真实

1. 平面变换节点的检查器, 选择设置--启用运动模糊:
   - 质量: 5
   - 快门角度: 130

![planar](/Users/maverick/Documents/Note/media/PlanarTracker.png)

### 小结:

- 平面跟踪器PlanarTracker获得跟踪数据, 关键点: 绘制形状 "set", "go"
- 时间拉伸器TimeStretcher创建冻结帧, 源时间输入帧数指定冻结帧, 关键点是取消掉自动关键帧
- (可选)清除标志: 画笔节点--Viewer上面选择Stroke--检查器应用控制: 克隆, 用法类似PS中的"仿制图章"
- 蒙版控制MatteControl可输入垃圾蒙版, 可将图像与蒙版结合!
  - 说人话: 想蒙版与图像结合在一起, 就要输入到蒙版控制节点的垃圾蒙版灰色端口
- 预除/后乘: 工作原理类似压缩包, 保存需要预乘, 处理时不需要, 那么就要在处理前"预除", 完成后进行"后乘"
- 四角定位器: 调整替代图像的位置和变形, 坐标系以左下角原点, 百分比为单位
- 平面变换: 处理不规则多边形蒙版, 创建方式为平面跟踪器检查器中"创建平面变换"
- 逻辑流程:
  1. 平面跟踪器获得跟踪数据
  2. 时间拉伸器创建冻结帧提供给后续使用
  3. 添加替换图像到冻结帧
  4. 四角定位调整替换图像位置
  5. 蒙版控制搞定蒙版与图像结合
  6. 使用平面变换匹配多边形蒙版形状, 平面变换来自平面跟踪器

再重新捋一遍:

1. PlanarTracker绘制形状, 追踪数据
2. 新建分支
   - TimeStetcher创建冻结帧
   - Paint清除标记点
   - 导入图像, CornerPositioner定位变形, BrightnessContrast调整色彩
   - 多边形绘制区域, 使用MatteControl垃圾蒙版输入接收
3. PlanarTracker创建PlanarTransform将跟踪数据传过去
4. 删除PlanarTracker, PlanarTransform连入主线
5. 加运动模糊, 收尾

### 实战练习

用眼睛的冻结帧来代替有些抽动的眼皮, 保证在整个过程中眼睛保持静止

![](/Users/maverick/Documents/Note/media/man.png)

任务的关键点在于TimeStretcher创建冻结帧时, 定位与PlanarTracker相同, 且关闭关键帧.

## 5 合成绿幕内容

抠像, 术语为键控(Keying)

键控处理是一种生成蒙版的程序化（Procedural）方法，它和您在之前的课程中使用的手动绘制蒙版的方法不一样。使用绿幕进行合成操作本身就是一门艺术，但大多数键控操作都遵循简单的工作流程。窍门就是不要尝试使用单个键控节点来做所有事情。键控时首先把注意力聚焦在前景主体的边缘细节上，然后使用其他工具处理其他区域。最后，把多个蒙版结合在一起往往能更快地获得更好的结果。

### 5.1 色彩基础知识

Fusion合成操作更倾向于Linear Gamma(线性伽马)的图像, 素材当中有很多是非线性伽马. 正确地合成方法是: 首先将非线性伽马转换为线性伽马, 其次进行合成处理, 最后反转过程重新转换为非线性伽马进行输出.
很麻烦? 对!
幸运的是, 达芬奇可自动处理这一过程: 项目设置里的色彩管理启用: DaVinci YRGB Color Management(达芬奇色彩管理)即可.
Fusion合成操作使用线性伽马的底层原因是因为数学, 线性更容易计算.

### 5.2 DeltaKeyer

小知识: ChromaKeyer(色度键控器)表示基于图像中的色相和饱和度范围提取蒙版, 而DeltaKeyer(Delta键控器)则是利用色差来提取蒙版.

1. 选择MediaIn添加DeltaKeyer, 检查器中背景颜色拖拽吸管到绿幕背景上, 释放鼠标位置最好靠近人物
2. 默认的透明背景以棋盘格表示, 但会掩盖不需要的噪点, 在监视器菜单中关闭"显示方形像素"
3. 选择Viewer点击A, 以Alpha方式显示蒙版, 可以看清灰色噪点
   - 调高增益(Gain)滑块从绿色背景中减去更多数值. 一般1.3以下是安全的
   - 调节平衡(Balance)滑块, 决定从键控颜色(这里是绿色)以外的颜色(红蓝)中获取更多或更少的信息
4. 优化蒙版: 检查器中选择预蒙版Pre-Matte选项卡, 作用是消除背景中的噪点
   - 柔化范围调节至0.02
   - 侵蚀调节至0.002
   - 在蒙版周围拖出矩形框来消除噪点, 毛发附近要小心, 远离主体的部分不用理,使用其他方式优化
5. 选择蒙版Matte选项卡: 包含用于修改蒙版的密度和边缘的参数, 是最重要的选项卡. **蒙版的质量决定了键控的质量!**
   - 阈值滑块可以设置黑白截止点的范围, 小于低阈值设置的值视为纯黑(透明), 大于高阈值设置的值被视为纯白色(不透明)
   - 低阈值过高会侵蚀掉发丝之类的细节, 高阈值过低会导致微小的细节合并在一起
   - 清理前景/背景: 细微化调整(按住Cmd拖动), 可以用来填充出现在蒙版的黑色和白色部分的小孔, 副作用是容易使得蒙版边缘粗糙

在不牺牲一些头发细节的情况下, 不可能将蒙版优化到每一帧上的每一个像素都完美无缺. 需要结合其他工具来优化.

### 5.3 动态遮罩辅助蒙版

- 垃圾蒙版: 去除绿幕没有覆盖到的场景区域
  - "B样条线"绘制方法类似多边形, 但不用手柄调整曲率, 记得反转蒙版
  - "B-样条曲线"连接到DeltaKeyer的垃圾蒙版输入端口
  - 动态遮罩: 在序列帧上绘制多边形或B样条线蒙版并对其进行动画处理的工作被称为动态遮罩(ROTO)
  - 制作要点: DeltaKeyer蒙版在出圈的前一帧, 扩大遮罩; 空余太多的部分, 收缩遮罩. 每次修改自动添加关键帧
- 保留蒙版: 覆盖前景中不需要的, 键控工具也没捕捉到的半透明区域
  - 多边形圈出前景中的灰色(半透明)区域, 连接到DeltaKeyer的实体蒙版输入端口
  - 与垃圾蒙版类似, 调整形状, 自动添加关键帧

垃圾蒙版还好, 保留蒙版的动态遮罩制作太麻烦了!

### 5.4 颜色校正元素

对背景和前景进行颜色校正的两个原因:

1. 去除前景主体上残留的绿色
   - DeltaKeyer检查器中蒙版选项卡--替换模式: 来源
   - 此时会重新引入一定数量的原始绿幕像素, 可在下面的颜色校正器中轻松去除
2. 匹配前景和背景的色彩, 是它们看起来真实地存在于相同的场景中
   - 在DeltaKeyer后添加颜色校正器
   - 检查器中的顶部选择"抑制", 抑制色轮可以将溢出色的控制点向中心移动, 从而降低饱和度
   - 溢出色抑制会显著降低图像的亮度. 可通过提高亮度来对冲.

### 蒙版发送到调色页面

蒙版复用减少劳动时间, 充分利用两个页面各自擅长的领域

操作:

- 在颜色校正节点后添加MediaOut节点即可
- 调色页面节点区, 右击空白处--添加源, 将第二个源连入节点的Alpha输入端口

### 小结:

貌似长篇大论, 实际上核心点就是DeltaKeyer, 其中最高优先级是蒙版边缘质量, 原则为: 不要指望一个工具解决所有问题

- 吸管取样位置尽量靠近人物, 这样更准确, 也是高质量蒙版的起步
- 检查器选项卡:
  - 键控: 基本调节
    - 增益: 从绿色背景中减去数值大小, 一般1.3以下是安全的
    - 平衡: 红蓝两色的取舍
  - 预蒙版: 消除背景中的噪点
    - 柔化范围: 0.02
    - 侵蚀: 0.002
    - 拖矩形消除噪点
  - 蒙版: 修改蒙版的密度和边缘, 最重要
    - 阈值: 小于低点视为纯黑(透明), 高于高点视为纯白(不透明)
    - 低阈值过高会损失毛发等细节, 高阈值过低会导致微小的细节合并在一起
    - 清理前/背景: Cmd+拖拽, 细微化调整黑白两色当中的空洞; 副作用为使得蒙版边缘变得粗糙
    - 替换模式: 来源, 会引入一些绿色溢出色, 交由后续颜色校正去除
- 垃圾蒙版: 去除远离前景的背景噪点, 若无, 可省略; 注意连接到DeltaKeyer垃圾蒙版端口
- 保留蒙版: 覆盖前景当中不需要的, DeltaKeyer没能去除的部分, 实体蒙版入口连接到DeltaKeyer
- 颜色校正: 检查器中选择"抑制", 色轮中把溢出色向中心拖动, 以降低饱和度, 后续适度提高亮度用以对冲
- 蒙版复用: 可交由调色页面继续使用

实际应用中, 吸管取样位置准确, DeltaKeyer检查器中键控/预蒙版/蒙版参数调整精确, 其他工具可忽略

![](/Users/maverick/Documents/Note/media/Keyer.png)

## 6 滚动字幕

只在影视剧中才能用到, 目前没用, 略过

## 7 标题模版

一般来说, 字体的变化通常意味着意义的变化. 太多的字体会分散注意力, 让观众感到困惑. 所以, 要在一个项目中只使用一到两个字体. 使用粗体/细体/斜体等来实现标题样式的多样化.

### 7.1 使用蒙版创建简单动画

静态文本暗示着观众: "快走, 这里没啥好看的", 即使最小的文本运动方式也会增加平面字体的趣味性, 来帮助观众保持足够长的注意力来阅读信息

1. 文本前连接矩形工具节点, 只在矩形内的文本才会显示; 那么利用矩形和文本的相对位置可创建动画
2. 文本节点检查器--布局--调节中心Y值直到在矩形中消失, 添加关键帧
3. 移动播放头到文本完全显示时间点, 调节Y值, 直到文本完全显示, (会自动打上关键帧)

### 7.2 跟随器设置动画

跟随器Follower是一个顺序动画修改器, 它将关键帧动画应用于文本, 并在每个字符之间设置自定义延迟

1. 文本节点检查器--文本输入框--右击--跟随器
2. 此时顶部修改器选项卡激活, 进入. 可在位置/旋转/大小/色彩等多处设置关键帧. 一旦设计了动画就可以决定在字符之间放置多长的延迟
3. 变换--旋转--Y轴--输入-100, 点击添加关键帧
4. 播放头前进10帧, Y轴归零, 关键帧自动添加
5. 点击上面"时间"选项卡, 将延迟Delay拖至2: 意味着字符开始旋转的2帧之后, 下一个字符才能开始旋转, 即在每个字符间插入两帧停顿
6. 选择着色选项卡同理设置不透明度动画
7. 播放查看效果

再啰嗦一遍, 只要参数后面带菱形标记的皆可动画!

### 7.3 调整动画参数

两大神器: 样条编辑器和关键帧编辑器, 样条编辑器主要针对运动曲线, 关键帧编辑器主要针对动画位置, 时间等

1. 右上角点击关键帧编辑器, 左上部分点击节点编辑器, 以获得最大的展示空间; 关键帧编辑器中右上角点击适配缩放, 同时点击过滤器选择Animated, 只显示设置了动画的内容.
2. 垂直细线代表了关键帧, 对其改动可编辑动画持续时间, 位置等
3. 右下角时间窗口可选偏移, 输入数据可快速更改
4. 单个关键帧还可更改插值(即淡入淡出等曲线编辑), 更强大灵活需要到样条编辑器

### 7.4 版本

单节点版本:
对单个节点来说, 可以有最多6个版本可以保存. 即可尝试不同的节点设置, 又不会丢失以前的工作成果
检查器中默认版本是1, 点击2之后所有的更改都将存入Version2中

更改默认值:
一个节点的设置有重复利用的价值, 可在节点编辑器中右击--设置--保存默认值; 再次新建节点时,就会自动调用现在的全部设置
重置: 右击节点--设置--重置默认值

时间线版本:
存储了所有片段的完整合成,  能够在保留对以前版本访问权限的同时对合成进行微小或重大的更改.

1. 右上角点击片段, 右击缩略图, 选择: 创建新合成(Create New Composition)
2. 旧版本1已经保存, 现在做的所有修改都会存储在版本2中

### 7.5 保存为模版

将目前的设计保存为特效库模版, 再次使用时只要修改文字内容即可, 这个Idea不错. 换一个角度, 特效库中的其他Fusion特性也是这么做出来的.

1. 单击选择"NAME"节点, Cmd+单击选择"TITLE"节点, Cmd+A选择所有剩余节点; 选择节点的顺序决定了它们在宏列表的显示顺序, 把重要的显示在前面.
2. 右击任意节点--"Macro宏"--"Create Macro创建宏"
   - 输入宏名称
   - 勾选Styled Text复选框, 文本框中输入"SUBJECT NAME"不要中文的原因是可能会显示乱码, 这是以后调用时出现在检查器中的内容
   - 关闭"NAME"旁的开合箭头, 同样勾选, 设置Styled Text
   - 关闭对话框, 保存模版; 默认位置只能通过Fusion面板调用
   - 选择"Templates(模版)--Edit--Titles--保存; 这样就能在Edit页面调用(保存不成功, 原因待查)

说明: 选择顺序决定了调用时检查器的显示顺序, 勾选哪个, 哪个是检查器中的可选项! 没勾选的不可见.

### 小结:

- 多种动画制作方法:
  - 蒙版
  - **跟随器**
- 关键帧编辑器的简单使用
- 版本控制:
  - 单节点
  - 时间线版本
- 保存为模版
  - 选取顺序决定显示顺序
  - 勾选与否决定是否可调整
  - 保存位置决定在哪里可以调用

## 8 关键帧和修改器设置动画

### 8.1 设置运动路径的关键帧

1. 导入地图和飞机图片, 飞机后加变换节点调整大小
2. 播放头置于开始位置, 调节变换节点检查器Center位置, 点击关键帧
3. 继续设置几个点, 自动添加关键帧, 直到飞机消失在地图中
4. Viewer顶部工具栏"选择所有点Select All Points", Shift+S设置平滑, 播放查看效果

### 8.2 自动设置对象的方向

将角度连接到"Path修改器", 解决飞机头朝向问题. 背后的原因是, Path数据可以共享

变换节点检查器, 右击"角度Angle"--连接到--Path1--朝向

### 8.3 绘制运动路径

使用"画笔Paint"制作视频特效和动态图形

1. 地图节点后添加Paint, Viewer顶部工具栏选择"多边形折线笔刷Polyline Stroke"
2. 在地图上随意两点画出一条直线, 然后取得数据, 然而数据是需要发布出来才能获取
3. 变换节点检查器--修改器--底部"Right-click here for shap animation鼠标右击此处为形状设置动画", 然后选择"发布Publish". 此时修改器选项卡出现"Path1: Polyilne路径1: 多边形折线"
4. 画笔节点检查器--修改器--笔刷控制Stroke control--"鼠标右击此处为形状设置动画"--右击--连接到--路径: 多边形折线--值
5. 画笔修改器--笔刷控件, 调节大小/柔和度/颜色/间距等, 画出一条红色虚线

随便一条直线的意义在于有了检查器中的修改器, 也就是有了接收数据的地方
数据发布与接收的理念很棒!
此时, 已经可以按线飞行了, 下面继续美化, 虚线随着飞机出现

6. 继续Paint画笔修改器--书写Write On下的"End" 右击--连接到--Path1--位移

### 8.4 调整速度

Fusion默认在关键帧之间应用线性插值, 因此动画以恒定速率来变化.
样条线编辑器: 全选--Shift+S平滑即可解决

其他美化, 电影胶片, 运动模糊
Done!

至此, 2D部分完工, 剩下的3D部分暂停
Date: 2025-03-17
